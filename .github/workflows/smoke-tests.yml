name: Smoke Tests

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to test (dev, staging, production)'
        required: true
        type: string
      gateway_url:
        description: 'API Gateway URL'
        required: true
        type: string
    secrets:
      DATABASE_URL:
        required: true
      REDIS_URL:
        required: true

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
        default: 'dev'

jobs:
  smoke-tests:
    name: Run Smoke Tests - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      fail-fast: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[test]"
          pip install pytest pytest-asyncio pytest-cov httpx redis sqlalchemy[asyncio]

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 30

          # Check API Gateway health
          max_retries=10
          retry_count=0

          while [ $retry_count -lt $max_retries ]; do
            if curl -f -s "${{ inputs.gateway_url }}/health" > /dev/null 2>&1; then
              echo "✓ API Gateway is ready"
              break
            fi
            retry_count=$((retry_count + 1))
            echo "Waiting for API Gateway... (attempt $retry_count/$max_retries)"
            sleep 5
          done

          if [ $retry_count -eq $max_retries ]; then
            echo "ERROR: API Gateway not ready after $max_retries attempts"
            exit 1
          fi

      - name: Run database smoke tests
        env:
          SMOKE_TEST_DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GATEWAY_URL: ${{ inputs.gateway_url }}
        run: |
          pytest tests/smoke/test_database_transactions.py \
            -v \
            -m "smoke and database" \
            --tb=short \
            --junit-xml=smoke-tests-database.xml

      - name: Run event bus smoke tests
        env:
          SMOKE_TEST_REDIS_URL: ${{ secrets.REDIS_URL }}
          GATEWAY_URL: ${{ inputs.gateway_url }}
        run: |
          pytest tests/smoke/test_event_bus_flows.py \
            -v \
            -m "smoke and redis" \
            --tb=short \
            --junit-xml=smoke-tests-eventbus.xml

      - name: Run service communication smoke tests
        env:
          GATEWAY_URL: ${{ inputs.gateway_url }}
          SMOKE_TEST_DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SMOKE_TEST_REDIS_URL: ${{ secrets.REDIS_URL }}
        run: |
          pytest tests/smoke/test_service_communication.py \
            -v \
            -m "smoke and service" \
            --tb=short \
            --junit-xml=smoke-tests-services.xml

      - name: Generate test report
        if: always()
        run: |
          pytest tests/smoke \
            -m smoke \
            --html=smoke-test-report.html \
            --self-contained-html \
            --junit-xml=smoke-tests-all.xml \
            || true
        env:
          SMOKE_TEST_DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SMOKE_TEST_REDIS_URL: ${{ secrets.REDIS_URL }}
          GATEWAY_URL: ${{ inputs.gateway_url }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results-${{ inputs.environment }}
          path: |
            smoke-test-report.html
            smoke-tests-*.xml
          retention-days: 30

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: 'smoke-tests-*.xml'
          check_name: 'Smoke Test Results - ${{ inputs.environment }}'
          comment_mode: 'off'

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Smoke tests failed on ${{ inputs.environment }}"
          echo "Critical integration issues detected. Deployment may need rollback."
          exit 1

      - name: Summary
        if: always()
        run: |
          echo "## Smoke Test Summary - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ inputs.environment }}**" >> $GITHUB_STEP_SUMMARY
          echo "Gateway URL: ${{ inputs.gateway_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f smoke-tests-all.xml ]; then
            echo "✓ Test results generated" >> $GITHUB_STEP_SUMMARY
          else
            echo "✗ Test results not generated" >> $GITHUB_STEP_SUMMARY
          fi
