"""
Penetration Testing Data Models
AI-powered security testing for SOC audit control validation
"""
import enum
from datetime import datetime, date
from typing import List, Optional
from uuid import UUID, uuid4

from sqlalchemy import (
    String, Text, Integer, Boolean, Date, DECIMAL,
    ForeignKey, Index, CheckConstraint, ARRAY
)
from sqlalchemy.dialects.postgresql import UUID as PGUUID, INET, JSONB
from sqlalchemy.orm import Mapped, mapped_column, relationship
from sqlalchemy.sql import func
from sqlalchemy import Enum as SQLEnum, TIMESTAMP

from .database import Base


# ============================================================================
# ENUMS
# ============================================================================

class PentestType(str, enum.Enum):
    EXTERNAL_NETWORK = "EXTERNAL_NETWORK"
    INTERNAL_NETWORK = "INTERNAL_NETWORK"
    WEB_APPLICATION = "WEB_APPLICATION"
    API = "API"
    CLOUD_INFRASTRUCTURE = "CLOUD_INFRASTRUCTURE"
    WIRELESS = "WIRELESS"
    SOCIAL_ENGINEERING = "SOCIAL_ENGINEERING"
    PHYSICAL = "PHYSICAL"
    RED_TEAM = "RED_TEAM"


class PentestStatus(str, enum.Enum):
    SCOPING = "SCOPING"
    AUTHORIZED = "AUTHORIZED"
    SCHEDULED = "SCHEDULED"
    IN_PROGRESS = "IN_PROGRESS"
    PAUSED = "PAUSED"
    COMPLETED = "COMPLETED"
    REPORT_DRAFT = "REPORT_DRAFT"
    REPORT_FINAL = "REPORT_FINAL"
    REMEDIATION = "REMEDIATION"
    RETEST = "RETEST"
    CLOSED = "CLOSED"


class VulnerabilitySeverity(str, enum.Enum):
    CRITICAL = "CRITICAL"  # CVSS 9.0-10.0
    HIGH = "HIGH"          # CVSS 7.0-8.9
    MEDIUM = "MEDIUM"      # CVSS 4.0-6.9
    LOW = "LOW"            # CVSS 0.1-3.9
    INFO = "INFO"          # Informational


class VulnerabilityStatus(str, enum.Enum):
    OPEN = "OPEN"
    CONFIRMED = "CONFIRMED"
    FALSE_POSITIVE = "FALSE_POSITIVE"
    ACCEPTED_RISK = "ACCEPTED_RISK"
    REMEDIATED = "REMEDIATED"
    RETEST_REQUIRED = "RETEST_REQUIRED"
    RETEST_PASSED = "RETEST_PASSED"
    RETEST_FAILED = "RETEST_FAILED"


class ScanType(str, enum.Enum):
    VULNERABILITY_SCAN = "VULNERABILITY_SCAN"
    PORT_SCAN = "PORT_SCAN"
    SSL_TLS_SCAN = "SSL_TLS_SCAN"
    WEB_SCAN = "WEB_SCAN"
    API_SCAN = "API_SCAN"
    CREDENTIAL_SCAN = "CREDENTIAL_SCAN"
    COMPLIANCE_SCAN = "COMPLIANCE_SCAN"
    AI_THREAT_DETECTION = "AI_THREAT_DETECTION"


class ExploitResult(str, enum.Enum):
    SUCCESS = "SUCCESS"
    PARTIAL_SUCCESS = "PARTIAL_SUCCESS"
    FAILED = "FAILED"
    BLOCKED = "BLOCKED"
    NOT_ATTEMPTED = "NOT_ATTEMPTED"


# ============================================================================
# PENETRATION TESTING ENGAGEMENT
# ============================================================================

class PentestEngagement(Base):
    __tablename__ = "pentest_engagements"
    __table_args__ = {"schema": "soc_copilot"}

    id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), primary_key=True, default=uuid4)
    soc_engagement_id: Mapped[Optional[UUID]] = mapped_column(
        PGUUID(as_uuid=True),
        ForeignKey("soc_copilot.soc_engagements.id", ondelete="CASCADE"),
        index=True
    )

    # Engagement details
    pentest_name: Mapped[str] = mapped_column(String(500), nullable=False)
    pentest_type: Mapped[PentestType] = mapped_column(SQLEnum(PentestType), nullable=False)
    status: Mapped[PentestStatus] = mapped_column(SQLEnum(PentestStatus), default=PentestStatus.SCOPING, index=True)

    # Scope
    target_description: Mapped[str] = mapped_column(Text, nullable=False)
    in_scope_assets: Mapped[List[str]] = mapped_column(ARRAY(Text), nullable=False)
    out_of_scope_assets: Mapped[Optional[List[str]]] = mapped_column(ARRAY(Text))
    ip_ranges: Mapped[Optional[List[str]]] = mapped_column(ARRAY(INET))
    domain_names: Mapped[Optional[List[str]]] = mapped_column(ARRAY(Text))

    # Authorization
    authorization_letter_path: Mapped[Optional[str]] = mapped_column(Text)
    authorized_by: Mapped[Optional[UUID]] = mapped_column(PGUUID(as_uuid=True), ForeignKey("soc_copilot.users.id"))
    authorized_at: Mapped[Optional[datetime]] = mapped_column(TIMESTAMP(timezone=True))
    authorization_expiry: Mapped[Optional[datetime]] = mapped_column(TIMESTAMP(timezone=True))

    # Testing window
    start_date: Mapped[Optional[date]] = mapped_column(Date)
    end_date: Mapped[Optional[date]] = mapped_column(Date)
    allowed_hours: Mapped[Optional[str]] = mapped_column(String(100))

    # Team
    lead_pentester_id: Mapped[Optional[UUID]] = mapped_column(
        PGUUID(as_uuid=True),
        ForeignKey("soc_copilot.users.id"),
        index=True
    )
    team_members: Mapped[Optional[List[str]]] = mapped_column(ARRAY(PGUUID(as_uuid=True)))

    # Rules of engagement
    rules_of_engagement: Mapped[Optional[str]] = mapped_column(Text)
    emergency_contact_name: Mapped[Optional[str]] = mapped_column(String(255))
    emergency_contact_phone: Mapped[Optional[str]] = mapped_column(String(50))

    # AI configuration
    enable_ai_scanning: Mapped[bool] = mapped_column(Boolean, default=True)
    enable_ai_threat_intel: Mapped[bool] = mapped_column(Boolean, default=True)
    ai_risk_threshold: Mapped[float] = mapped_column(DECIMAL(3, 2), default=0.70)

    # Metadata
    created_by: Mapped[Optional[UUID]] = mapped_column(PGUUID(as_uuid=True), ForeignKey("soc_copilot.users.id"))
    created_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())
    updated_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())
    completed_at: Mapped[Optional[datetime]] = mapped_column(TIMESTAMP(timezone=True))

    # Relationships
    targets: Mapped[List["PentestTarget"]] = relationship(back_populates="engagement", cascade="all, delete-orphan")
    scans: Mapped[List["PentestScan"]] = relationship(back_populates="engagement", cascade="all, delete-orphan")
    vulnerabilities: Mapped[List["Vulnerability"]] = relationship(back_populates="engagement", cascade="all, delete-orphan")


class PentestTarget(Base):
    __tablename__ = "pentest_targets"
    __table_args__ = {"schema": "soc_copilot"}

    id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), primary_key=True, default=uuid4)
    pentest_engagement_id: Mapped[UUID] = mapped_column(
        PGUUID(as_uuid=True),
        ForeignKey("soc_copilot.pentest_engagements.id", ondelete="CASCADE"),
        index=True
    )

    # Target identification
    target_name: Mapped[str] = mapped_column(String(255), nullable=False)
    target_type: Mapped[str] = mapped_column(String(100), nullable=False)
    ip_address: Mapped[Optional[str]] = mapped_column(INET, index=True)
    hostname: Mapped[Optional[str]] = mapped_column(String(255))
    url: Mapped[Optional[str]] = mapped_column(Text)

    # Asset metadata
    criticality: Mapped[str] = mapped_column(String(50), default="MEDIUM")
    business_owner: Mapped[Optional[str]] = mapped_column(String(255))
    technical_owner: Mapped[Optional[str]] = mapped_column(String(255))
    description: Mapped[Optional[str]] = mapped_column(Text)

    # Technology stack
    os_detected: Mapped[Optional[str]] = mapped_column(String(100))
    services: Mapped[Optional[dict]] = mapped_column(JSONB)
    technologies: Mapped[Optional[List[str]]] = mapped_column(ARRAY(Text))

    # Testing status
    scan_completed: Mapped[bool] = mapped_column(Boolean, default=False)
    exploit_attempted: Mapped[bool] = mapped_column(Boolean, default=False)
    compromised: Mapped[bool] = mapped_column(Boolean, default=False)

    created_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())
    updated_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())

    # Relationships
    engagement: Mapped["PentestEngagement"] = relationship(back_populates="targets")
    scans: Mapped[List["PentestScan"]] = relationship(back_populates="target", cascade="all, delete-orphan")
    vulnerabilities: Mapped[List["Vulnerability"]] = relationship(back_populates="target", cascade="all, delete-orphan")


# ============================================================================
# SCANS
# ============================================================================

class PentestScan(Base):
    __tablename__ = "pentest_scans"
    __table_args__ = {"schema": "soc_copilot"}

    id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), primary_key=True, default=uuid4)
    pentest_engagement_id: Mapped[UUID] = mapped_column(
        PGUUID(as_uuid=True),
        ForeignKey("soc_copilot.pentest_engagements.id", ondelete="CASCADE"),
        index=True
    )
    target_id: Mapped[UUID] = mapped_column(
        PGUUID(as_uuid=True),
        ForeignKey("soc_copilot.pentest_targets.id", ondelete="CASCADE"),
        index=True
    )

    # Scan details
    scan_type: Mapped[ScanType] = mapped_column(SQLEnum(ScanType), nullable=False, index=True)
    scan_name: Mapped[str] = mapped_column(String(255), nullable=False)
    scan_tool: Mapped[Optional[str]] = mapped_column(String(100))

    # Configuration
    scan_config: Mapped[Optional[dict]] = mapped_column(JSONB)

    # AI enhancement
    ai_enhanced: Mapped[bool] = mapped_column(Boolean, default=False)
    ai_model_used: Mapped[Optional[str]] = mapped_column(String(100))
    ai_confidence_score: Mapped[Optional[float]] = mapped_column(DECIMAL(3, 2))

    # Execution
    started_at: Mapped[Optional[datetime]] = mapped_column(TIMESTAMP(timezone=True))
    completed_at: Mapped[Optional[datetime]] = mapped_column(TIMESTAMP(timezone=True))
    duration_seconds: Mapped[Optional[int]] = mapped_column(Integer)

    # Results
    findings_count: Mapped[int] = mapped_column(Integer, default=0)
    critical_count: Mapped[int] = mapped_column(Integer, default=0)
    high_count: Mapped[int] = mapped_column(Integer, default=0)
    medium_count: Mapped[int] = mapped_column(Integer, default=0)
    low_count: Mapped[int] = mapped_column(Integer, default=0)
    info_count: Mapped[int] = mapped_column(Integer, default=0)

    # Output
    raw_output_path: Mapped[Optional[str]] = mapped_column(Text)
    parsed_results: Mapped[Optional[dict]] = mapped_column(JSONB)

    # Status
    status: Mapped[str] = mapped_column(String(50), default="PENDING")
    error_message: Mapped[Optional[str]] = mapped_column(Text)

    executed_by: Mapped[Optional[UUID]] = mapped_column(PGUUID(as_uuid=True), ForeignKey("soc_copilot.users.id"))
    created_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())

    # Relationships
    engagement: Mapped["PentestEngagement"] = relationship(back_populates="scans")
    target: Mapped["PentestTarget"] = relationship(back_populates="scans")


# ============================================================================
# VULNERABILITIES
# ============================================================================

class Vulnerability(Base):
    __tablename__ = "vulnerabilities"
    __table_args__ = {"schema": "soc_copilot"}

    id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), primary_key=True, default=uuid4)
    pentest_engagement_id: Mapped[UUID] = mapped_column(
        PGUUID(as_uuid=True),
        ForeignKey("soc_copilot.pentest_engagements.id", ondelete="CASCADE"),
        index=True
    )
    target_id: Mapped[UUID] = mapped_column(
        PGUUID(as_uuid=True),
        ForeignKey("soc_copilot.pentest_targets.id", ondelete="CASCADE"),
        index=True
    )
    scan_id: Mapped[Optional[UUID]] = mapped_column(
        PGUUID(as_uuid=True),
        ForeignKey("soc_copilot.pentest_scans.id")
    )

    # Identification
    vuln_title: Mapped[str] = mapped_column(String(500), nullable=False)
    vuln_description: Mapped[str] = mapped_column(Text, nullable=False)
    cve_id: Mapped[Optional[str]] = mapped_column(String(50), index=True)
    cwe_id: Mapped[Optional[str]] = mapped_column(String(50))

    # Severity & scoring
    severity: Mapped[VulnerabilitySeverity] = mapped_column(SQLEnum(VulnerabilitySeverity), nullable=False, index=True)
    cvss_score: Mapped[Optional[float]] = mapped_column(DECIMAL(3, 1))
    cvss_vector: Mapped[Optional[str]] = mapped_column(String(100))

    # AI risk scoring
    ai_risk_score: Mapped[Optional[float]] = mapped_column(DECIMAL(3, 2))
    ai_risk_factors: Mapped[Optional[dict]] = mapped_column(JSONB)
    ai_recommended_priority: Mapped[Optional[str]] = mapped_column(String(50))

    # Technical details
    affected_component: Mapped[Optional[str]] = mapped_column(String(255))
    affected_url: Mapped[Optional[str]] = mapped_column(Text)
    affected_parameter: Mapped[Optional[str]] = mapped_column(String(255))
    vulnerability_type: Mapped[Optional[str]] = mapped_column(String(100))

    # Evidence
    proof_of_concept: Mapped[Optional[str]] = mapped_column(Text)
    evidence_screenshots: Mapped[Optional[List[str]]] = mapped_column(ARRAY(Text))
    request_response: Mapped[Optional[dict]] = mapped_column(JSONB)

    # SOC control mapping
    related_control_objectives: Mapped[Optional[List[str]]] = mapped_column(ARRAY(PGUUID(as_uuid=True)))
    control_gap_analysis: Mapped[Optional[str]] = mapped_column(Text)

    # Remediation
    remediation_recommendation: Mapped[str] = mapped_column(Text, nullable=False)
    remediation_complexity: Mapped[Optional[str]] = mapped_column(String(50))
    estimated_remediation_hours: Mapped[Optional[float]] = mapped_column(DECIMAL(5, 1))

    # AI remediation
    ai_remediation_steps: Mapped[Optional[str]] = mapped_column(Text)
    ai_code_fix_suggestion: Mapped[Optional[str]] = mapped_column(Text)

    # Status
    status: Mapped[VulnerabilityStatus] = mapped_column(
        SQLEnum(VulnerabilityStatus),
        default=VulnerabilityStatus.OPEN,
        index=True
    )
    assigned_to: Mapped[Optional[UUID]] = mapped_column(PGUUID(as_uuid=True), ForeignKey("soc_copilot.users.id"))

    # Discovery
    discovered_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())
    discovered_by: Mapped[Optional[UUID]] = mapped_column(PGUUID(as_uuid=True), ForeignKey("soc_copilot.users.id"))

    # Verification
    verified: Mapped[bool] = mapped_column(Boolean, default=False)
    verified_by: Mapped[Optional[UUID]] = mapped_column(PGUUID(as_uuid=True), ForeignKey("soc_copilot.users.id"))
    verified_at: Mapped[Optional[datetime]] = mapped_column(TIMESTAMP(timezone=True))

    # Remediation tracking
    remediation_plan: Mapped[Optional[str]] = mapped_column(Text)
    remediation_deadline: Mapped[Optional[date]] = mapped_column(Date)
    remediated_at: Mapped[Optional[datetime]] = mapped_column(TIMESTAMP(timezone=True))
    remediation_notes: Mapped[Optional[str]] = mapped_column(Text)

    # Retesting
    retest_scheduled_date: Mapped[Optional[date]] = mapped_column(Date)
    retest_result: Mapped[Optional[ExploitResult]] = mapped_column(SQLEnum(ExploitResult))
    retested_at: Mapped[Optional[datetime]] = mapped_column(TIMESTAMP(timezone=True))
    retested_by: Mapped[Optional[UUID]] = mapped_column(PGUUID(as_uuid=True), ForeignKey("soc_copilot.users.id"))

    created_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())
    updated_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())

    # Relationships
    engagement: Mapped["PentestEngagement"] = relationship(back_populates="vulnerabilities")
    target: Mapped["PentestTarget"] = relationship(back_populates="vulnerabilities")
    exploit_attempts: Mapped[List["ExploitAttempt"]] = relationship(back_populates="vulnerability", cascade="all, delete-orphan")


class ExploitAttempt(Base):
    __tablename__ = "exploit_attempts"
    __table_args__ = {"schema": "soc_copilot"}

    id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), primary_key=True, default=uuid4)
    vulnerability_id: Mapped[UUID] = mapped_column(
        PGUUID(as_uuid=True),
        ForeignKey("soc_copilot.vulnerabilities.id", ondelete="CASCADE"),
        index=True
    )
    pentest_engagement_id: Mapped[UUID] = mapped_column(
        PGUUID(as_uuid=True),
        ForeignKey("soc_copilot.pentest_engagements.id", ondelete="CASCADE"),
        index=True
    )

    # Exploit details
    exploit_name: Mapped[str] = mapped_column(String(255), nullable=False)
    exploit_type: Mapped[Optional[str]] = mapped_column(String(100))
    exploit_description: Mapped[Optional[str]] = mapped_column(Text)

    # Execution
    executed_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())
    executed_by: Mapped[Optional[UUID]] = mapped_column(PGUUID(as_uuid=True), ForeignKey("soc_copilot.users.id"))

    # Result
    result: Mapped[ExploitResult] = mapped_column(SQLEnum(ExploitResult), nullable=False)
    impact_description: Mapped[Optional[str]] = mapped_column(Text)

    # Evidence
    console_output: Mapped[Optional[str]] = mapped_column(Text)
    screenshots: Mapped[Optional[List[str]]] = mapped_column(ARRAY(Text))
    captured_data: Mapped[Optional[dict]] = mapped_column(JSONB)

    # Post-exploitation
    persistence_achieved: Mapped[bool] = mapped_column(Boolean, default=False)
    lateral_movement_attempted: Mapped[bool] = mapped_column(Boolean, default=False)
    privilege_escalation_achieved: Mapped[bool] = mapped_column(Boolean, default=False)
    data_exfiltration_simulated: Mapped[bool] = mapped_column(Boolean, default=False)

    # AI analysis
    ai_exploit_analysis: Mapped[Optional[str]] = mapped_column(Text)
    ai_impact_score: Mapped[Optional[float]] = mapped_column(DECIMAL(3, 2))

    # Authorization
    authorization_confirmed: Mapped[bool] = mapped_column(Boolean, default=True)

    created_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())

    # Relationships
    vulnerability: Mapped["Vulnerability"] = relationship(back_populates="exploit_attempts")


# ============================================================================
# AI THREAT INTELLIGENCE
# ============================================================================

class AIThreatIntel(Base):
    __tablename__ = "ai_threat_intel"
    __table_args__ = {"schema": "soc_copilot"}

    id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), primary_key=True, default=uuid4)
    pentest_engagement_id: Mapped[UUID] = mapped_column(
        PGUUID(as_uuid=True),
        ForeignKey("soc_copilot.pentest_engagements.id", ondelete="CASCADE"),
        index=True
    )

    # Threat identification
    threat_name: Mapped[str] = mapped_column(String(255), nullable=False)
    threat_type: Mapped[Optional[str]] = mapped_column(String(100))

    # AI detection
    detected_by_ai: Mapped[bool] = mapped_column(Boolean, default=True)
    ai_model_version: Mapped[Optional[str]] = mapped_column(String(50))
    confidence_score: Mapped[float] = mapped_column(DECIMAL(3, 2), nullable=False, index=True)

    # Threat details
    description: Mapped[str] = mapped_column(Text, nullable=False)
    indicators_of_compromise: Mapped[Optional[dict]] = mapped_column(JSONB)
    attack_vectors: Mapped[Optional[List[str]]] = mapped_column(ARRAY(Text))
    affected_assets: Mapped[Optional[List[str]]] = mapped_column(ARRAY(PGUUID(as_uuid=True)))

    # Intelligence sources
    threat_intel_sources: Mapped[Optional[List[str]]] = mapped_column(ARRAY(Text))
    mitre_attack_techniques: Mapped[Optional[List[str]]] = mapped_column(ARRAY(Text))

    # Risk assessment
    likelihood: Mapped[Optional[str]] = mapped_column(String(50))
    business_impact: Mapped[Optional[str]] = mapped_column(String(50))
    overall_risk_rating: Mapped[Optional[str]] = mapped_column(String(50))

    # Recommendations
    ai_recommended_actions: Mapped[Optional[str]] = mapped_column(Text)

    detected_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())
    created_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())


# ============================================================================
# PENTEST REPORTS
# ============================================================================

class PentestReport(Base):
    __tablename__ = "pentest_reports"
    __table_args__ = {"schema": "soc_copilot"}

    id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), primary_key=True, default=uuid4)
    pentest_engagement_id: Mapped[UUID] = mapped_column(
        PGUUID(as_uuid=True),
        ForeignKey("soc_copilot.pentest_engagements.id", ondelete="CASCADE"),
        index=True
    )

    # Report metadata
    report_title: Mapped[str] = mapped_column(String(500), nullable=False)
    report_type: Mapped[str] = mapped_column(String(100), default="FULL_PENTEST")
    report_version: Mapped[int] = mapped_column(Integer, default=1)

    # Executive summary
    executive_summary: Mapped[Optional[str]] = mapped_column(Text)
    ai_generated_summary: Mapped[bool] = mapped_column(Boolean, default=False)

    # Report sections
    scope_section: Mapped[Optional[str]] = mapped_column(Text)
    methodology_section: Mapped[Optional[str]] = mapped_column(Text)
    findings_summary: Mapped[Optional[str]] = mapped_column(Text)
    detailed_findings: Mapped[Optional[str]] = mapped_column(Text)
    risk_analysis: Mapped[Optional[str]] = mapped_column(Text)
    recommendations: Mapped[Optional[str]] = mapped_column(Text)

    # SOC integration
    control_validation_results: Mapped[Optional[str]] = mapped_column(Text)
    control_effectiveness_assessment: Mapped[Optional[str]] = mapped_column(Text)

    # Metrics
    total_vulnerabilities: Mapped[int] = mapped_column(Integer, default=0)
    critical_vulns: Mapped[int] = mapped_column(Integer, default=0)
    high_vulns: Mapped[int] = mapped_column(Integer, default=0)
    medium_vulns: Mapped[int] = mapped_column(Integer, default=0)
    low_vulns: Mapped[int] = mapped_column(Integer, default=0)

    # AI insights
    ai_risk_assessment: Mapped[Optional[str]] = mapped_column(Text)
    ai_prioritization: Mapped[Optional[str]] = mapped_column(Text)
    ai_remediation_roadmap: Mapped[Optional[str]] = mapped_column(Text)

    # Files
    pdf_path: Mapped[Optional[str]] = mapped_column(Text)
    html_path: Mapped[Optional[str]] = mapped_column(Text)
    json_export_path: Mapped[Optional[str]] = mapped_column(Text)

    # Status
    is_draft: Mapped[bool] = mapped_column(Boolean, default=True)
    finalized_at: Mapped[Optional[datetime]] = mapped_column(TIMESTAMP(timezone=True))
    finalized_by: Mapped[Optional[UUID]] = mapped_column(PGUUID(as_uuid=True), ForeignKey("soc_copilot.users.id"))

    # Delivery
    delivered_to_client: Mapped[bool] = mapped_column(Boolean, default=False)
    delivered_at: Mapped[Optional[datetime]] = mapped_column(TIMESTAMP(timezone=True))

    created_by: Mapped[Optional[UUID]] = mapped_column(PGUUID(as_uuid=True), ForeignKey("soc_copilot.users.id"))
    created_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())
    updated_at: Mapped[datetime] = mapped_column(TIMESTAMP(timezone=True), server_default=func.now())
