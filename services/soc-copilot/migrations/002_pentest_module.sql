-- Penetration Testing Module for SOC Copilot
-- Enables CPA firms to perform authorized security testing of client environments
-- to validate SOC 1/2 controls and identify security vulnerabilities

SET search_path TO soc_copilot, public;

-- ============================================================================
-- ENUM TYPES
-- ============================================================================

CREATE TYPE pentest_type AS ENUM (
    'EXTERNAL_NETWORK',      -- External infrastructure testing
    'INTERNAL_NETWORK',      -- Internal network testing
    'WEB_APPLICATION',       -- Web app security testing
    'API',                   -- API security testing
    'CLOUD_INFRASTRUCTURE',  -- AWS/Azure/GCP testing
    'WIRELESS',              -- WiFi security testing
    'SOCIAL_ENGINEERING',    -- Phishing simulations
    'PHYSICAL',              -- Physical security testing
    'RED_TEAM'               -- Full adversary simulation
);

CREATE TYPE pentest_status AS ENUM (
    'SCOPING',
    'AUTHORIZED',
    'SCHEDULED',
    'IN_PROGRESS',
    'PAUSED',
    'COMPLETED',
    'REPORT_DRAFT',
    'REPORT_FINAL',
    'REMEDIATION',
    'RETEST',
    'CLOSED'
);

CREATE TYPE vulnerability_severity AS ENUM (
    'CRITICAL',   -- CVSS 9.0-10.0
    'HIGH',       -- CVSS 7.0-8.9
    'MEDIUM',     -- CVSS 4.0-6.9
    'LOW',        -- CVSS 0.1-3.9
    'INFO'        -- Informational
);

CREATE TYPE vulnerability_status AS ENUM (
    'OPEN',
    'CONFIRMED',
    'FALSE_POSITIVE',
    'ACCEPTED_RISK',
    'REMEDIATED',
    'RETEST_REQUIRED',
    'RETEST_PASSED',
    'RETEST_FAILED'
);

CREATE TYPE scan_type AS ENUM (
    'VULNERABILITY_SCAN',
    'PORT_SCAN',
    'SSL_TLS_SCAN',
    'WEB_SCAN',
    'API_SCAN',
    'CREDENTIAL_SCAN',
    'COMPLIANCE_SCAN',
    'AI_THREAT_DETECTION'
);

CREATE TYPE exploit_result AS ENUM (
    'SUCCESS',
    'PARTIAL_SUCCESS',
    'FAILED',
    'BLOCKED',
    'NOT_ATTEMPTED'
);

-- ============================================================================
-- PENETRATION TESTING ENGAGEMENTS
-- ============================================================================

CREATE TABLE pentest_engagements (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    soc_engagement_id UUID REFERENCES soc_engagements(id) ON DELETE CASCADE,

    -- Engagement details
    pentest_name VARCHAR(500) NOT NULL,
    pentest_type pentest_type NOT NULL,
    status pentest_status DEFAULT 'SCOPING',

    -- Scope
    target_description TEXT NOT NULL,
    in_scope_assets TEXT[] NOT NULL,
    out_of_scope_assets TEXT[],
    ip_ranges INET[],
    domain_names TEXT[],

    -- Authorization
    authorization_letter_path TEXT,
    authorized_by UUID REFERENCES users(id),
    authorized_at TIMESTAMPTZ,
    authorization_expiry TIMESTAMPTZ,

    -- Testing window
    start_date DATE,
    end_date DATE,
    allowed_hours VARCHAR(100),  -- e.g., "9am-5pm EST, weekdays only"

    -- Team
    lead_pentester_id UUID REFERENCES users(id),
    team_members UUID[] DEFAULT ARRAY[]::UUID[],

    -- Rules of engagement
    rules_of_engagement TEXT,
    emergency_contact_name VARCHAR(255),
    emergency_contact_phone VARCHAR(50),

    -- AI configuration
    enable_ai_scanning BOOLEAN DEFAULT TRUE,
    enable_ai_threat_intel BOOLEAN DEFAULT TRUE,
    ai_risk_threshold DECIMAL(3,2) DEFAULT 0.70,  -- AI confidence threshold

    -- Metadata
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ,

    CONSTRAINT valid_date_range CHECK (end_date >= start_date)
);

CREATE INDEX idx_pentest_engagements_soc ON pentest_engagements(soc_engagement_id);
CREATE INDEX idx_pentest_engagements_status ON pentest_engagements(status);
CREATE INDEX idx_pentest_engagements_lead ON pentest_engagements(lead_pentester_id);

-- ============================================================================
-- ASSETS & TARGETS
-- ============================================================================

CREATE TABLE pentest_targets (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    pentest_engagement_id UUID REFERENCES pentest_engagements(id) ON DELETE CASCADE,

    -- Target identification
    target_name VARCHAR(255) NOT NULL,
    target_type VARCHAR(100) NOT NULL,  -- server, application, network, endpoint
    ip_address INET,
    hostname VARCHAR(255),
    url TEXT,

    -- Asset metadata
    criticality VARCHAR(50) DEFAULT 'MEDIUM',  -- CRITICAL, HIGH, MEDIUM, LOW
    business_owner VARCHAR(255),
    technical_owner VARCHAR(255),
    description TEXT,

    -- Technology stack (AI will analyze this)
    os_detected VARCHAR(100),
    services JSONB,  -- Detected services and versions
    technologies TEXT[],  -- Web frameworks, databases, etc.

    -- Testing status
    scan_completed BOOLEAN DEFAULT FALSE,
    exploit_attempted BOOLEAN DEFAULT FALSE,
    compromised BOOLEAN DEFAULT FALSE,

    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_pentest_targets_engagement ON pentest_targets(pentest_engagement_id);
CREATE INDEX idx_pentest_targets_ip ON pentest_targets(ip_address);

-- ============================================================================
-- SCANS & AUTOMATED TESTING
-- ============================================================================

CREATE TABLE pentest_scans (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    pentest_engagement_id UUID REFERENCES pentest_engagements(id) ON DELETE CASCADE,
    target_id UUID REFERENCES pentest_targets(id) ON DELETE CASCADE,

    -- Scan details
    scan_type scan_type NOT NULL,
    scan_name VARCHAR(255) NOT NULL,
    scan_tool VARCHAR(100),  -- nmap, nessus, burp, custom_ai

    -- Scan configuration
    scan_config JSONB,  -- Tool-specific configuration

    -- AI enhancement
    ai_enhanced BOOLEAN DEFAULT FALSE,
    ai_model_used VARCHAR(100),
    ai_confidence_score DECIMAL(3,2),

    -- Execution
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    duration_seconds INTEGER,

    -- Results
    findings_count INTEGER DEFAULT 0,
    critical_count INTEGER DEFAULT 0,
    high_count INTEGER DEFAULT 0,
    medium_count INTEGER DEFAULT 0,
    low_count INTEGER DEFAULT 0,
    info_count INTEGER DEFAULT 0,

    -- Raw output
    raw_output_path TEXT,
    parsed_results JSONB,

    -- Status
    status VARCHAR(50) DEFAULT 'PENDING',
    error_message TEXT,

    executed_by UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_pentest_scans_engagement ON pentest_scans(pentest_engagement_id);
CREATE INDEX idx_pentest_scans_target ON pentest_scans(target_id);
CREATE INDEX idx_pentest_scans_type ON pentest_scans(scan_type);

-- ============================================================================
-- VULNERABILITIES
-- ============================================================================

CREATE TABLE vulnerabilities (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    pentest_engagement_id UUID REFERENCES pentest_engagements(id) ON DELETE CASCADE,
    target_id UUID REFERENCES pentest_targets(id) ON DELETE CASCADE,
    scan_id UUID REFERENCES pentest_scans(id),

    -- Vulnerability identification
    vuln_title VARCHAR(500) NOT NULL,
    vuln_description TEXT NOT NULL,
    cve_id VARCHAR(50),  -- CVE-2024-1234
    cwe_id VARCHAR(50),  -- CWE-89 (SQL Injection)

    -- Severity & scoring
    severity vulnerability_severity NOT NULL,
    cvss_score DECIMAL(3,1),
    cvss_vector VARCHAR(100),

    -- AI-enhanced risk scoring
    ai_risk_score DECIMAL(3,2),
    ai_risk_factors JSONB,  -- Exploitability, prevalence, business impact
    ai_recommended_priority VARCHAR(50),

    -- Technical details
    affected_component VARCHAR(255),
    affected_url TEXT,
    affected_parameter VARCHAR(255),
    vulnerability_type VARCHAR(100),  -- SQL injection, XSS, RCE, etc.

    -- Evidence
    proof_of_concept TEXT,
    evidence_screenshots TEXT[],  -- Paths to screenshot files
    request_response JSONB,  -- HTTP request/response for web vulns

    -- SOC Control mapping
    related_control_objectives UUID[],  -- Maps to control_objectives table
    control_gap_analysis TEXT,

    -- Recommendations
    remediation_recommendation TEXT NOT NULL,
    remediation_complexity VARCHAR(50),  -- SIMPLE, MODERATE, COMPLEX
    estimated_remediation_hours DECIMAL(5,1),

    -- AI-generated remediation
    ai_remediation_steps TEXT,
    ai_code_fix_suggestion TEXT,

    -- Status tracking
    status vulnerability_status DEFAULT 'OPEN',
    assigned_to UUID REFERENCES users(id),

    -- Discovery
    discovered_at TIMESTAMPTZ DEFAULT NOW(),
    discovered_by UUID REFERENCES users(id),

    -- Verification
    verified BOOLEAN DEFAULT FALSE,
    verified_by UUID REFERENCES users(id),
    verified_at TIMESTAMPTZ,

    -- Remediation tracking
    remediation_plan TEXT,
    remediation_deadline DATE,
    remediated_at TIMESTAMPTZ,
    remediation_notes TEXT,

    -- Retesting
    retest_scheduled_date DATE,
    retest_result exploit_result,
    retested_at TIMESTAMPTZ,
    retested_by UUID REFERENCES users(id),

    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_vulnerabilities_engagement ON vulnerabilities(pentest_engagement_id);
CREATE INDEX idx_vulnerabilities_target ON vulnerabilities(target_id);
CREATE INDEX idx_vulnerabilities_severity ON vulnerabilities(severity);
CREATE INDEX idx_vulnerabilities_status ON vulnerabilities(status);
CREATE INDEX idx_vulnerabilities_cve ON vulnerabilities(cve_id);

-- ============================================================================
-- EXPLOITATION ATTEMPTS
-- ============================================================================

CREATE TABLE exploit_attempts (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    vulnerability_id UUID REFERENCES vulnerabilities(id) ON DELETE CASCADE,
    pentest_engagement_id UUID REFERENCES pentest_engagements(id) ON DELETE CASCADE,

    -- Exploit details
    exploit_name VARCHAR(255) NOT NULL,
    exploit_type VARCHAR(100),  -- manual, metasploit, custom_script, ai_generated
    exploit_description TEXT,

    -- Execution
    executed_at TIMESTAMPTZ DEFAULT NOW(),
    executed_by UUID REFERENCES users(id),

    -- Result
    result exploit_result NOT NULL,
    impact_description TEXT,

    -- Evidence
    console_output TEXT,
    screenshots TEXT[],
    captured_data JSONB,  -- Hashes, credentials (encrypted), etc.

    -- Post-exploitation
    persistence_achieved BOOLEAN DEFAULT FALSE,
    lateral_movement_attempted BOOLEAN DEFAULT FALSE,
    privilege_escalation_achieved BOOLEAN DEFAULT FALSE,
    data_exfiltration_simulated BOOLEAN DEFAULT FALSE,

    -- AI analysis
    ai_exploit_analysis TEXT,
    ai_impact_score DECIMAL(3,2),

    -- Authorization check
    authorization_confirmed BOOLEAN DEFAULT TRUE,

    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_exploit_attempts_vuln ON exploit_attempts(vulnerability_id);
CREATE INDEX idx_exploit_attempts_engagement ON exploit_attempts(pentest_engagement_id);

-- ============================================================================
-- AI THREAT INTELLIGENCE
-- ============================================================================

CREATE TABLE ai_threat_intel (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    pentest_engagement_id UUID REFERENCES pentest_engagements(id) ON DELETE CASCADE,

    -- Threat identification
    threat_name VARCHAR(255) NOT NULL,
    threat_type VARCHAR(100),  -- malware, attack_pattern, vulnerability, misconfiguration

    -- AI detection
    detected_by_ai BOOLEAN DEFAULT TRUE,
    ai_model_version VARCHAR(50),
    confidence_score DECIMAL(3,2) NOT NULL,

    -- Threat details
    description TEXT NOT NULL,
    indicators_of_compromise JSONB,  -- IOCs: IPs, domains, file hashes
    attack_vectors TEXT[],
    affected_assets UUID[],  -- References to pentest_targets

    -- Intelligence sources
    threat_intel_sources TEXT[],  -- MITRE ATT&CK, CVE databases, etc.
    mitre_attack_techniques TEXT[],  -- T1071, T1059, etc.

    -- Risk assessment
    likelihood VARCHAR(50),
    business_impact VARCHAR(50),
    overall_risk_rating VARCHAR(50),

    -- Recommendations
    ai_recommended_actions TEXT,

    detected_at TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_ai_threat_intel_engagement ON ai_threat_intel(pentest_engagement_id);
CREATE INDEX idx_ai_threat_intel_confidence ON ai_threat_intel(confidence_score DESC);

-- ============================================================================
-- SOCIAL ENGINEERING CAMPAIGNS
-- ============================================================================

CREATE TABLE social_engineering_campaigns (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    pentest_engagement_id UUID REFERENCES pentest_engagements(id) ON DELETE CASCADE,

    -- Campaign details
    campaign_name VARCHAR(255) NOT NULL,
    campaign_type VARCHAR(100),  -- phishing, vishing, smishing, pretexting

    -- AI-generated content
    ai_generated_emails BOOLEAN DEFAULT FALSE,
    ai_generated_websites BOOLEAN DEFAULT FALSE,
    ai_model_used VARCHAR(100),

    -- Target list
    target_emails TEXT[],
    target_count INTEGER,

    -- Campaign execution
    launched_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,

    -- Results
    emails_sent INTEGER DEFAULT 0,
    emails_opened INTEGER DEFAULT 0,
    links_clicked INTEGER DEFAULT 0,
    credentials_submitted INTEGER DEFAULT 0,
    malware_executed INTEGER DEFAULT 0,

    -- Success metrics
    success_rate DECIMAL(5,2),  -- Percentage
    click_through_rate DECIMAL(5,2),

    -- Evidence
    campaign_artifacts_path TEXT,
    screenshots TEXT[],

    created_by UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_social_engineering_engagement ON social_engineering_campaigns(pentest_engagement_id);

-- ============================================================================
-- PENETRATION TESTING REPORTS
-- ============================================================================

CREATE TABLE pentest_reports (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    pentest_engagement_id UUID REFERENCES pentest_engagements(id) ON DELETE CASCADE,

    -- Report metadata
    report_title VARCHAR(500) NOT NULL,
    report_type VARCHAR(100) DEFAULT 'FULL_PENTEST',
    report_version INTEGER DEFAULT 1,

    -- Executive summary (AI-generated)
    executive_summary TEXT,
    ai_generated_summary BOOLEAN DEFAULT FALSE,

    -- Report sections
    scope_section TEXT,
    methodology_section TEXT,
    findings_summary TEXT,
    detailed_findings TEXT,
    risk_analysis TEXT,
    recommendations TEXT,

    -- SOC integration
    control_validation_results TEXT,  -- How findings map to SOC controls
    control_effectiveness_assessment TEXT,

    -- Metrics
    total_vulnerabilities INTEGER DEFAULT 0,
    critical_vulns INTEGER DEFAULT 0,
    high_vulns INTEGER DEFAULT 0,
    medium_vulns INTEGER DEFAULT 0,
    low_vulns INTEGER DEFAULT 0,

    -- AI insights
    ai_risk_assessment TEXT,
    ai_prioritization TEXT,
    ai_remediation_roadmap TEXT,

    -- Files
    pdf_path TEXT,
    html_path TEXT,
    json_export_path TEXT,

    -- Status
    is_draft BOOLEAN DEFAULT TRUE,
    finalized_at TIMESTAMPTZ,
    finalized_by UUID REFERENCES users(id),

    -- Delivery
    delivered_to_client BOOLEAN DEFAULT FALSE,
    delivered_at TIMESTAMPTZ,

    created_by UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_pentest_reports_engagement ON pentest_reports(pentest_engagement_id);

-- ============================================================================
-- COMPLIANCE MAPPING
-- ============================================================================

CREATE TABLE pentest_control_validations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    pentest_engagement_id UUID REFERENCES pentest_engagements(id) ON DELETE CASCADE,
    control_objective_id UUID REFERENCES control_objectives(id),
    control_id UUID REFERENCES controls(id),

    -- Validation details
    validation_method VARCHAR(100),  -- automated_scan, manual_test, exploit_attempt
    validation_date TIMESTAMPTZ DEFAULT NOW(),

    -- Result
    control_effective BOOLEAN,
    validation_evidence TEXT,

    -- Findings
    related_vulnerabilities UUID[],  -- References to vulnerabilities table
    gap_description TEXT,

    -- Recommendations
    control_improvement_recommendations TEXT,

    validated_by UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_pentest_validations_engagement ON pentest_control_validations(pentest_engagement_id);
CREATE INDEX idx_pentest_validations_control ON pentest_control_validations(control_id);

-- ============================================================================
-- ATTACK SURFACE ANALYSIS (AI-Powered)
-- ============================================================================

CREATE TABLE attack_surface_analysis (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    pentest_engagement_id UUID REFERENCES pentest_engagements(id) ON DELETE CASCADE,

    -- Analysis metadata
    analysis_date TIMESTAMPTZ DEFAULT NOW(),
    analysis_type VARCHAR(100),  -- external, internal, cloud, full

    -- AI-discovered assets
    discovered_domains INTEGER DEFAULT 0,
    discovered_subdomains INTEGER DEFAULT 0,
    discovered_ips INTEGER DEFAULT 0,
    discovered_services INTEGER DEFAULT 0,
    discovered_apis INTEGER DEFAULT 0,

    -- Asset inventory
    asset_inventory JSONB,  -- Comprehensive asset list

    -- Exposure analysis
    internet_exposed_assets JSONB,
    sensitive_data_exposure JSONB,
    misconfigured_services JSONB,

    -- AI risk scoring
    overall_attack_surface_score DECIMAL(5,2),
    ai_risk_heatmap JSONB,

    -- Recommendations
    ai_remediation_priorities TEXT[],

    analyzed_by VARCHAR(100) DEFAULT 'AI_AGENT',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_attack_surface_engagement ON attack_surface_analysis(pentest_engagement_id);

-- ============================================================================
-- AUDIT TRAIL FOR PENTEST ACTIVITIES
-- ============================================================================

CREATE TABLE pentest_audit_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    pentest_engagement_id UUID REFERENCES pentest_engagements(id) ON DELETE CASCADE,

    -- Event details
    event_type VARCHAR(100) NOT NULL,
    event_description TEXT NOT NULL,

    -- Actor
    actor_id UUID REFERENCES users(id),
    actor_ip INET,

    -- Target
    target_asset VARCHAR(255),

    -- Technical details
    command_executed TEXT,
    tool_used VARCHAR(100),

    -- Result
    success BOOLEAN,
    error_message TEXT,

    -- Authorization
    within_scope BOOLEAN DEFAULT TRUE,
    authorization_checked BOOLEAN DEFAULT TRUE,

    timestamp TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_pentest_audit_engagement ON pentest_audit_log(pentest_engagement_id);
CREATE INDEX idx_pentest_audit_timestamp ON pentest_audit_log(timestamp DESC);

-- ============================================================================
-- TRIGGERS
-- ============================================================================

-- Update timestamps
CREATE TRIGGER update_pentest_engagements_updated_at
    BEFORE UPDATE ON pentest_engagements
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_pentest_targets_updated_at
    BEFORE UPDATE ON pentest_targets
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_vulnerabilities_updated_at
    BEFORE UPDATE ON vulnerabilities
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_pentest_reports_updated_at
    BEFORE UPDATE ON pentest_reports
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- COMMENTS
-- ============================================================================

COMMENT ON TABLE pentest_engagements IS 'Authorized penetration testing engagements for SOC audit control validation';
COMMENT ON TABLE vulnerabilities IS 'Security vulnerabilities discovered during penetration testing';
COMMENT ON TABLE ai_threat_intel IS 'AI-powered threat intelligence and risk detection';
COMMENT ON TABLE pentest_control_validations IS 'Validation of SOC controls through penetration testing';
COMMENT ON COLUMN vulnerabilities.ai_risk_score IS 'AI-calculated risk score considering exploitability, impact, and business context';

COMMIT;
